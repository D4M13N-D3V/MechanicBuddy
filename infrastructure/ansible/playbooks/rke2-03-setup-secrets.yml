---
# Setup Bitwarden Secret Operator and sync secrets
#
# Prerequisites:
# 1. Get your Bitwarden API credentials from:
#    https://bitwarden.d4m13n.dev/#/settings/security/security-keys
# 2. Add credentials to inventory/group_vars/all/vault.yml:
#    bitwarden_client_id: "user.xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
#    bitwarden_client_secret: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
#    bitwarden_master_password: "your-master-password"
# 3. Encrypt with: ansible-vault encrypt inventory/group_vars/all/vault.yml

- name: Setup Bitwarden secrets management
  hosts: k8s_control_plane[0]
  become: true
  gather_facts: true

  vars:
    kubeconfig_path: /etc/rancher/rke2/rke2.yaml
    kubectl_path: /var/lib/rancher/rke2/bin/kubectl
    bitwarden_host: "https://bitwarden.d4m13n.dev"

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/var/lib/rancher/rke2/bin:{{ ansible_env.PATH }}"

  tasks:
    # =========================================================================
    # Bitwarden Operator Setup
    # =========================================================================
    - name: Create Bitwarden credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: bitwarden-credentials
            namespace: bw-operator
          type: Opaque
          stringData:
            BW_HOST: "{{ bitwarden_host }}"
            BW_CLIENTID: "{{ bitwarden_client_id }}"
            BW_CLIENTSECRET: "{{ bitwarden_client_secret }}"
            BW_PASSWORD: "{{ bitwarden_master_password }}"

    - name: Install Bitwarden Secret Operator
      kubernetes.core.helm:
        name: bw-operator
        chart_ref: bitwarden-operator/bitwarden-secret-operator
        release_namespace: bw-operator
        create_namespace: true
        values:
          env:
            - name: BW_HOST
              valueFrom:
                secretKeyRef:
                  name: bitwarden-credentials
                  key: BW_HOST
            - name: BW_CLIENTID
              valueFrom:
                secretKeyRef:
                  name: bitwarden-credentials
                  key: BW_CLIENTID
            - name: BW_CLIENTSECRET
              valueFrom:
                secretKeyRef:
                  name: bitwarden-credentials
                  key: BW_CLIENTSECRET
            - name: BW_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: bitwarden-credentials
                  key: BW_PASSWORD
          # Sync interval in seconds
          syncInterval: 300

    - name: Wait for Bitwarden operator to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: bw-operator
        label_selectors:
          - app.kubernetes.io/name=bitwarden-secret-operator
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300

    # =========================================================================
    # Create Application Namespaces
    # =========================================================================
    - name: Create mechanicbuddy-system namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: mechanicbuddy-system
            labels:
              app: mechanicbuddy

    - name: Create mechanicbuddy-free-tier namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: mechanicbuddy-free-tier
            labels:
              app: mechanicbuddy

    # =========================================================================
    # Create BitwardenSecret Resources
    # =========================================================================
    # Note: You need to create these items in Bitwarden first!
    # Each item should be a "Secure Note" with custom fields

    - name: Create GHCR credentials BitwardenSecret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: bitwarden.com/v1
          kind: BitwardenSecret
          metadata:
            name: ghcr-credentials
            namespace: mechanicbuddy-system
          spec:
            name: ghcr-credentials
            namespace: mechanicbuddy-system
            # Bitwarden item ID for GHCR credentials
            # Create a Secure Note in Bitwarden with custom fields:
            #   - username: your-github-username
            #   - password: ghp_xxxxxxxxxxxxxxxxxxxx (PAT)
            content:
              - element:
                  secretName: ghcr-credentials
                  secretScope: mechanicbuddy-system
                bwItem: "{{ bitwarden_ghcr_item_id }}"
                bwField: username
              - element:
                  secretName: ghcr-credentials
                  secretScope: mechanicbuddy-system
                bwItem: "{{ bitwarden_ghcr_item_id }}"
                bwField: password
      when: bitwarden_ghcr_item_id is defined

    # =========================================================================
    # Manual Secret Creation (Fallback if Bitwarden items not setup)
    # =========================================================================
    - name: Create GHCR pull secret (manual)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: ghcr-credentials
            namespace: "{{ item }}"
          type: kubernetes.io/dockerconfigjson
          stringData:
            .dockerconfigjson: |
              {
                "auths": {
                  "ghcr.io": {
                    "username": "{{ ghcr_username | default('mechanicbuddy') }}",
                    "password": "{{ ghcr_token }}",
                    "auth": "{{ (ghcr_username | default('mechanicbuddy') + ':' + ghcr_token) | b64encode }}"
                  }
                }
              }
      loop:
        - mechanicbuddy-system
        - mechanicbuddy-free-tier
      when: ghcr_token is defined

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Get secrets in all namespaces
      ansible.builtin.command: "{{ kubectl_path }} get secrets -A | grep -E '(mechanicbuddy|ghcr)'"
      register: secrets_output
      changed_when: false
      failed_when: false

    - name: Display summary
      ansible.builtin.debug:
        msg: |
          ================================================
          Bitwarden Secret Operator Configured!
          ================================================

          Bitwarden Host: {{ bitwarden_host }}

          Namespaces Created:
          - mechanicbuddy-system
          - mechanicbuddy-free-tier

          Secrets:
          {{ secrets_output.stdout | default('No secrets found yet') }}

          ================================================
          IMPORTANT: Setup Bitwarden Items
          ================================================

          Create these items in Bitwarden as "Secure Notes" with custom fields:

          1. "mechanicbuddy-ghcr" (for container registry)
             Custom fields:
             - username: your-github-username
             - password: ghp_xxxxxxxxxxxx (GitHub PAT with packages:read)

          2. "mechanicbuddy-secrets" (for application)
             Custom fields:
             - jwt-secret: (64+ random characters)
             - consumer-secret: (32+ random characters)
             - session-secret: (32+ random characters)
             - resend-api-key: re_xxxxxxxxxxxx

          3. "mechanicbuddy-stripe" (for payments)
             Custom fields:
             - publishable-key: pk_live_xxxx
             - secret-key: sk_live_xxxx
             - webhook-secret: whsec_xxxx

          4. "mechanicbuddy-postgres" (for database)
             Custom fields:
             - superuser-password: (strong password)
             - management-password: (strong password)
             - freetier-password: (strong password)

          After creating items, get their IDs and add to vars file.

          Next step:
          Run rke2-04-deploy-apps.yml to deploy MechanicBuddy
