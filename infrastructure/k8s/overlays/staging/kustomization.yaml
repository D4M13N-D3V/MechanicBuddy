apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mechanicbuddy-system

resources:
  - ../../base
  - secrets.yaml

# Staging-specific patches
patches:
  # Reduce replicas for staging
  - target:
      kind: Deployment
      name: management-api
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
  - target:
      kind: Deployment
      name: management-portal
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1

  # Use staging domain
  - target:
      kind: Ingress
      name: mechanicbuddy-system
    patch: |
      - op: replace
        path: /spec/rules/0/host
        value: staging.mechanicbuddy.app
      - op: replace
        path: /spec/rules/1/host
        value: www.staging.mechanicbuddy.app
      - op: replace
        path: /spec/rules/2/host
        value: api.staging.mechanicbuddy.app
      - op: replace
        path: /spec/tls/0/hosts
        value:
          - staging.mechanicbuddy.app
          - www.staging.mechanicbuddy.app
      - op: replace
        path: /spec/tls/1/hosts
        value:
          - api.staging.mechanicbuddy.app

configMapGenerator:
  - name: mechanicbuddy-config
    behavior: merge
    literals:
      - BASE_DOMAIN=staging.mechanicbuddy.app

# Image tags - updated by CI/CD
images:
  - name: management-api
    newName: ghcr.io/mechanicbuddy/management-api
    newTag: latest  # CI updates this
  - name: management-portal
    newName: ghcr.io/mechanicbuddy/management-portal
    newTag: latest  # CI updates this
  - name: management-dbup
    newName: ghcr.io/mechanicbuddy/management-dbup
    newTag: latest  # CI updates this

labels:
  - pairs:
      environment: staging
    includeSelectors: false
