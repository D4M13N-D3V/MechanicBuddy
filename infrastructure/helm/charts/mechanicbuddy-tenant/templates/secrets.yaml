apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mechanicbuddy-tenant.appSecretName" . }}
  namespace: tenant-{{ .Values.tenant.id }}
  labels:
    {{- include "mechanicbuddy-tenant.labels" . | nindent 4 }}
type: Opaque
stringData:
  # JWT Secret (64 hex characters) - auto-generated if not provided
  jwt-secret: {{ default (randAlphaNum 64) .Values.secrets.jwtSecret | quote }}
  # Consumer Secret (32 characters) - must match frontend SERVER_SECRET
  consumer-secret: {{ default (randAlphaNum 32) .Values.secrets.consumerSecret | quote }}
  # Session Secret (32 characters) - for frontend session encryption
  session-secret: {{ default (randAlphaNum 32) .Values.secrets.sessionSecret | quote }}
  # Resend API key (for sending emails to customers)
  resend-api-key: {{ .Values.email.apiKey | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mechanicbuddy-tenant.fullname" . }}-config
  namespace: tenant-{{ .Values.tenant.id }}
  labels:
    {{- include "mechanicbuddy-tenant.labels" . | nindent 4 }}
data:
  # Tenant configuration
  TENANT_ID: {{ .Values.tenant.id | quote }}
  TENANT_NAME: {{ .Values.tenant.name | quote }}
  TENANT_TIER: {{ .Values.tenant.tier | quote }}

  # Database configuration
  DB_HOST: {{ printf "%s-postgres-rw" (include "mechanicbuddy-tenant.fullname" .) | quote }}
  DB_PORT: "5432"
  DB_NAME: {{ .Values.postgresql.database | quote }}
  DB_USER: {{ .Values.postgresql.username | quote }}

  # Feature flags based on tier
  {{- if eq .Values.tenant.tier "demo" }}
  DEMO_MODE: "true"
  DEMO_EXPIRES: {{ now | dateModify (printf "+%dh" (mul .Values.demo.expirationDays 24)) | date "2006-01-02T15:04:05Z" | quote }}
  {{- else }}
  DEMO_MODE: "false"
  {{- end }}

  # Billing
  {{- if .Values.billing.stripeCustomerId }}
  STRIPE_CUSTOMER_ID: {{ .Values.billing.stripeCustomerId | quote }}
  {{- end }}
  {{- if .Values.billing.mechanicLimit }}
  MECHANIC_LIMIT: {{ .Values.billing.mechanicLimit | quote }}
  {{- else if eq .Values.tenant.tier "free" }}
  MECHANIC_LIMIT: "1"
  {{- end }}
