apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mechanicbuddy-system.appSecretName" . }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mechanicbuddy-system.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Stripe secrets
  stripe-secret-key: {{ .Values.stripe.secretKey | quote }}
  stripe-webhook-secret: {{ .Values.stripe.webhookSecret | quote }}

  # Email provider
  email-api-key: {{ .Values.email.apiKey | quote }}

  {{- if .Values.cloudflare.enabled }}
  # Cloudflare API token
  cloudflare-api-token: {{ .Values.cloudflare.apiToken | quote }}
  {{- end }}

  # JWT secrets for management API
  jwt-secret: {{ default (randAlphaNum 64) .Values.secrets.jwtSecret | quote }}
  session-secret: {{ default (randAlphaNum 32) .Values.secrets.sessionSecret | quote }}

  # Initial super admin password
  super-admin-password: {{ default (randAlphaNum 16) .Values.superAdmin.initialPassword | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mechanicbuddy-system.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mechanicbuddy-system.labels" . | nindent 4 }}
data:
  # Domain configuration
  BASE_DOMAIN: {{ .Values.global.domain | quote }}
  MANAGEMENT_URL: {{ printf "https://%s" .Values.global.domain | quote }}
  API_URL: {{ printf "https://api.%s" .Values.global.domain | quote }}

  # Database
  DB_HOST: {{ printf "%s-postgres-rw" (include "mechanicbuddy-system.fullname" .) | quote }}
  DB_PORT: "5432"
  DB_NAME: {{ .Values.postgresql.database | quote }}
  DB_USER: {{ .Values.postgresql.username | quote }}

  # Stripe
  STRIPE_PUBLISHABLE_KEY: {{ .Values.stripe.publishableKey | quote }}
  STRIPE_PRICE_FREE: {{ .Values.stripe.prices.free | quote }}
  STRIPE_PRICE_STANDARD: {{ .Values.stripe.prices.standard | quote }}
  STRIPE_PRICE_GROWTH: {{ .Values.stripe.prices.growth | quote }}
  STRIPE_PRICE_SCALE: {{ .Values.stripe.prices.scale | quote }}

  # Email
  EMAIL_FROM_ADDRESS: {{ .Values.email.fromAddress | quote }}
  EMAIL_FROM_NAME: {{ .Values.email.fromName | quote }}

  # Super admin
  SUPER_ADMIN_EMAIL: {{ .Values.superAdmin.initialEmail | quote }}

  {{- if .Values.cloudflare.enabled }}
  # Cloudflare
  CLOUDFLARE_ZONE_ID: {{ .Values.cloudflare.zoneId | quote }}
  {{- end }}
