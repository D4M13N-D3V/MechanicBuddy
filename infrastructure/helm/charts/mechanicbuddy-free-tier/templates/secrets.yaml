apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mechanicbuddy-free-tier.appSecretName" . }}
  namespace: {{ include "mechanicbuddy-free-tier.namespace" . }}
  labels:
    {{- include "mechanicbuddy-free-tier.labels" . | nindent 4 }}
type: Opaque
stringData:
  # JWT Secret (64 hex characters) - auto-generated if not provided
  jwt-secret: {{ default (randAlphaNum 64) .Values.secrets.jwtSecret | quote }}
  # Consumer Secret (32 characters) - must match frontend SERVER_SECRET
  consumer-secret: {{ default (randAlphaNum 32) .Values.secrets.consumerSecret | quote }}
  # Session Secret (32 characters) - for frontend session encryption
  session-secret: {{ default (randAlphaNum 32) .Values.secrets.sessionSecret | quote }}
  # Resend API key (for sending emails to customers)
  resend-api-key: {{ .Values.email.apiKey | quote }}
  # Database password (for external PostgreSQL cluster)
  db-password: {{ required "postgresql.password is required" .Values.postgresql.password | quote }}
  # appsettings.Secrets.json for API - minimal config, env vars override
  appsettings.Secrets.json: |
    {
      "DbOptions": {
        "Host": "{{ .Values.postgresql.host }}",
        "Port": "{{ .Values.postgresql.port }}",
        "Name": "{{ .Values.postgresql.database }}",
        "UserId": "{{ .Values.postgresql.username }}"
      },
      "JwtOptions": {
        "Issuer": "mechanicbuddy-free-tier",
        "Audience": "mechanicbuddy-free-tier"
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mechanicbuddy-free-tier.fullname" . }}-config
  namespace: {{ include "mechanicbuddy-free-tier.namespace" . }}
  labels:
    {{- include "mechanicbuddy-free-tier.labels" . | nindent 4 }}
data:
  # Instance configuration
  INSTANCE_ID: {{ .Values.instance.id | quote }}
  INSTANCE_TYPE: "free-tier-shared"

  # Database configuration (external shared cluster)
  DB_HOST: {{ .Values.postgresql.host | quote }}
  DB_PORT: {{ .Values.postgresql.port | quote }}
  DB_NAME: {{ .Values.postgresql.database | quote }}
  DB_USER: {{ .Values.postgresql.username | quote }}

  # Multi-tenancy is enabled for this instance
  MULTITENANCY_ENABLED: "true"
