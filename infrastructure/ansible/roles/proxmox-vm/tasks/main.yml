---
- name: Read SSH public key
  ansible.builtin.slurp:
    src: "{{ ssh_public_key_path }}"
  delegate_to: localhost
  become: false
  register: ssh_key_content

- name: Set SSH public key fact
  ansible.builtin.set_fact:
    ssh_public_key: "{{ ssh_key_content.content | b64decode | trim }}"

- name: Create cloud-init user data
  ansible.builtin.template:
    src: cloud-init-user-data.yml.j2
    dest: "/tmp/cloud-init-{{ item.name }}.yml"
    mode: '0644'
  delegate_to: localhost
  become: false
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"

- name: Clone VM from template
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port | default(8006) }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    node: "{{ proxmox_node }}"
    name: "{{ item.name }}"
    newid: "{{ item.vmid }}"
    clone: "{{ vm_template_name }}"
    full: true
    storage: "{{ vm_default_storage }}"
    timeout: "{{ vm_clone_timeout }}"
    state: present
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  register: vm_clone_result

- name: Configure VM hardware
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port | default(8006) }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ item.vmid }}"
    cores: "{{ item.cores | default(vm_default_cores) }}"
    memory: "{{ item.memory | default(vm_default_memory) }}"
    description: "{{ item.description | default('MechanicBuddy K8s Node') }}"
    onboot: true
    agent: "enabled=1"
    update: true
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"

- name: Resize VM disk
  ansible.builtin.command: >
    qm resize {{ item.vmid }} scsi0 {{ item.disk_size | default(vm_default_disk_size) }}
  delegate_to: "{{ proxmox_api_host }}"
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  changed_when: true
  ignore_errors: true

- name: Configure cloud-init network
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port | default(8006) }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ item.vmid }}"
    ipconfig:
      ipconfig0: "ip={{ item.ip }}/24,gw={{ network_gateway }}"
    nameservers: "{{ dns_servers | join(' ') }}"
    searchdomains: "{{ dns_search_domain }}"
    ciuser: "{{ vm_cloud_init_user }}"
    sshkeys: "{{ ssh_public_key }}"
    update: true
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"

- name: Start VMs
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port | default(8006) }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ item.vmid }}"
    state: started
    timeout: "{{ vm_start_timeout }}"
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  when: vm_start_on_create

- name: Wait for VMs to be reachable via SSH
  ansible.builtin.wait_for:
    host: "{{ item.ip }}"
    port: 22
    delay: 30
    timeout: 300
    state: started
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: localhost
  become: false

- name: Wait for cloud-init to complete
  ansible.builtin.command: cloud-init status --wait
  delegate_to: "{{ item.ip }}"
  remote_user: ubuntu
  loop: "{{ control_plane_nodes + worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  changed_when: false
  retries: 5
  delay: 30
  ignore_errors: true
