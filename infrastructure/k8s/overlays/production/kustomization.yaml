apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mechanicbuddy-system

resources:
  - ../../base
  # NOTE: All secrets are defined in base and overridden via patches below
  # Do NOT add secrets.yaml here to avoid ID conflicts

# Production-specific patches
# NOTE: For actual production, use SealedSecrets or External Secrets Operator
patches:
  # Override DB credentials
  - target:
      kind: Secret
      name: management-db-credentials
    patch: |
      - op: replace
        path: /stringData/password
        value: "ProductionDBPassword456!"
  # Override API secrets
  - target:
      kind: Secret
      name: management-api-secrets
    patch: |
      - op: replace
        path: /stringData/connection-string
        value: "Host=mechanicbuddy-management-db-rw;Port=5432;Database=mechanicbuddy_management;Username=management;Password=ProductionDBPassword456!"
      - op: replace
        path: /stringData/jwt-secret
        value: "REDACTED_JWT"
      - op: replace
        path: /stringData/stripe-secret-key
        value: "REDACTED_STRIPE_SK"
      - op: replace
        path: /stringData/stripe-webhook-secret
        value: "whsec_PRODUCTION_WEBHOOK_SECRET"
      - op: replace
        path: /stringData/resend-api-key
        value: "REDACTED_RESEND_KEY"
  # Override portal secrets
  - target:
      kind: Secret
      name: management-portal-secrets
    patch: |
      - op: replace
        path: /stringData/session-secret
        value: "ProductionSessionSecretMinimum32Characters!"
      - op: replace
        path: /stringData/stripe-publishable-key
        value: "REDACTED_STRIPE_PK"
  # Override cronjob secrets
  - target:
      kind: Secret
      name: cronjob-secrets
    patch: |
      - op: replace
        path: /stringData/api-token
        value: "production-cronjob-api-token-456"
  # Higher replicas for production
  - target:
      kind: Deployment
      name: management-api
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
  - target:
      kind: Deployment
      name: management-portal
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3

  # Higher resource limits for production
  - target:
      kind: Deployment
      name: management-api
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

  - target:
      kind: Deployment
      name: management-portal
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  # HA PostgreSQL for production
  - target:
      kind: Cluster
      name: mechanicbuddy-management-db
    patch: |
      - op: replace
        path: /spec/instances
        value: 3
      - op: replace
        path: /spec/storage/size
        value: "50Gi"
      - op: replace
        path: /spec/resources
        value:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "2000m"

configMapGenerator:
  - name: mechanicbuddy-config
    behavior: merge
    literals:
      - BASE_DOMAIN=mechanicbuddy.app

# Image tags - updated by CI/CD
images:
  - name: management-api
    newName: ghcr.io/d4m13n-d3v/mechanicbuddy-management-api
    newTag: latest  # CI updates this to specific SHA
  - name: management-portal
    newName: ghcr.io/d4m13n-d3v/mechanicbuddy-management-portal
    newTag: latest  # CI updates this to specific SHA
  - name: management-dbup
    newName: ghcr.io/d4m13n-d3v/mechanicbuddy-management-dbup
    newTag: latest  # CI updates this to specific SHA

labels:
  - pairs:
      environment: production
    includeSelectors: false
